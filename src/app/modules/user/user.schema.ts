import mongoose, { Schema } from "mongoose";
import { TUser } from "./user.interface";

const userSchema = new Schema<TUser>(
  {
    name: { type: String },
    phoneNumber: { type: String, required: true },
    email: { type: String, required: true, unique: true },
    role: {
      type: String,
      enum: ["user", "admin"],
      required: true,
      default: "user",
    },
    password: { type: String, required: true },
    invitationCode: {
      type: String,
      required: true,
      unique: true,
    },
    superiorUserId: { type: String },
    superiorUserName: { type: String },
    userId: {
      type: Number,
      unique: true,
      default: () => Math.floor(1000000 + Math.random() * 9000000),
    },
    userDiopsitType: {
      type: String,
      enum: ["trial", "deposit"],
      default: "trial",
    },

    orderRound: {
      type: {
        round: {
          type: String,
          enum: ["trial", "round_one", "round_two"],
          required: true,
          default: "trial",
        },
        status: {
          type: Boolean,
          default: true,
        },
      },
      default: {
        round: "trial",
        status: true,
      },
    },

    freezeUser: { type: Boolean, default: true },

    quantityOfOrders: { type: Number, default: 0 },
    completedOrdersCount: { type: Number, default: 0 },
    withdrawalAddressAndMethod: {
      type: {
        name: {
          type: String,
          required: true,
        },

        withdrawMethod: {
          type: String,
          enum: ["MobileBanking", "BankTransfer"],
          required: true,
        },

        // Bank Transfer fields
        bankName: {
          type: String,
          required: function () {
            return this.withdrawMethod === "BankTransfer";
          },
        },
        bankAccountNumber: {
          type: Number,
          required: function () {
            return this.withdrawMethod === "BankTransfer";
          },
        },
        branchName: {
          type: String,
        },
        district: {
          type: String,
        },

        // Mobile Banking fields
        mobileBankingName: {
          type: String,
          required: function () {
            return this.withdrawMethod === "MobileBanking";
          },
        },
        mobileBankingAccountNumber: {
          type: Number,
          required: function () {
            return this.withdrawMethod === "MobileBanking";
          },
        },
      },
      default: null,
    },

    withdrowalValidOddNumber: { type: Number, default: 0 },
    actualCompletedNumberToday: { type: Number, default: 0 },

    userBalance: { type: Number, required: true, default: 0 },
    trialRoundBalance: { type: Number, default: 0 },
    dailyProfit: { type: Number, default: 0 },
    freezeWithdraw: { type: Boolean, default: false },
    memberTotalRecharge: { type: Number, default: 0 },
    memberTotalWithdrawal: { type: Number, default: 0 },

    userOrderFreezingAmount: { type: Number, default: 0 },
    amountFrozedInWithdrawal: { type: Number, default: 0 },
    whetherOnline: { type: Boolean, default: true },
    mobilePhoneAreaCode: { type: String },

    lastLoginIp: { type: String },
    lastLoginTime: { type: Date },

    userType: { type: String, required: true, default: "Normal" },
    userOrderAmountSlot: {
      type: [Number],
      default: [10000, 30000, 50000, 100000, 200000, 300000, 500000,1000000],
    },
    userSelectedPackage: { type: Number },

    adminAssaignProductsOrRewards: {
      type: [
        {
          productId: { type: Number },
          orderNumber: { type: Number },
          mysterybox: {
            type: {
              method: {
                type: String,
                enum: ["cash", "12x"],
              },
              amount: {
                type: String,
              },
            },
            required: false, // âœ… optional
            default: undefined,
          },
        },
      ],
      default: [],
    },

    mysteryReward: {
      type: Number,
      default: 0,
    },
    dailyCheckInReward: {
      type: {
        lastCheckInDate: {
          type: Date,
          default: null,
        },
        totalCheckIns: {
          type: Number,
          default: 0,
        },
      },
      default: {
        lastCheckInDate: null,
        totalCheckIns: 0,
      },
    },

    completedOrderProducts: { type: [String], default: [] },
    orderCountForCheckIn: { type: Number, default: 0 },
    score: { type: Number, default: 0 },
    outOfBalance: { type: Number, default: 0 },
  },
  { timestamps: true },
);

export const User_Model = mongoose.model<TUser>("User", userSchema);








 // const isBlockedRound =
  //   user.orderRound.round !== "round_one" &&
  //   user.orderRound.status === false &&
  //   user.quantityOfOrders > 0;

  // console.log("is blocked", isBlockedRound);

  // if (!isBlockedRound) {
  //   throw new Error(
  //     "Please withdraw your money first, then select another package",
  //   );
  // }

  
//   const isBlockedRound =
//   !user.orderRound.status &&
//   user.quantityOfOrders > 0 &&
//   ["trial", "round_two"].includes(user.orderRound.round);

// if (isBlockedRound) {
//   throw new Error(
//     "Please withdraw your money first, then select another package",
//   );
// }



  //  const isBlockedRound =
  //   user.orderRound.round !== "round_one" &&
  //   user.orderRound.status === false &&
  //   user.quantityOfOrders > 0;

  // console.log("is blocked", isBlockedRound);

  // if (
  //   // (user?.orderRound.round === "trial" &&
  //   //   user?.orderRound.status === false &&
  //   //   user.quantityOfOrders > 0) ||
  //   // (user?.orderRound.round === "round_two" &&
  //   //   user?.orderRound.status === false &&
  //   //   user.quantityOfOrders > 0)
  //   !isBlockedRound
  // ) {
  //   throw new Error(
  //     "Please withdraw your money first, then select another package",
  //   );
  // }